<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Edit RSVP</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<style>
body{font:16px/1.4 Inter,system-ui;-webkit-font-smoothing:antialiased;margin:0;min-height:100vh;display:flex;align-items:flex-start;justify-content:center;padding:24px;background:url('./images/HackneyWick.png') center/cover fixed no-repeat;background-color:rgba(0,0,0,.08);background-blend-mode:multiply}
.wrap{max-width:720px;margin:0 auto;background:#fffdf6;border-radius:16px;padding:24px;box-shadow:0 16px 32px rgba(31,42,68,.15)}
label{font-weight:700;display:block;margin:.75rem 0 .25rem}
input,textarea,select,button{font:inherit}
input,textarea,select{width:100%;padding:.6rem;border:2px solid #e5e7eb;border-radius:10px;background:#fff}
button{margin-top:12px;padding:.7rem 1rem;border:0;border-radius:10px;background:#243354;color:#fff;font-weight:800}
.row{display:grid;grid-template-columns:minmax(0,2fr) minmax(0,1fr);gap:12px}
.hint{font-size:12px;color:#6b7280;margin-top:4px}
</style>
<div class="wrap">
  <h1>Edit your RSVP</h1>
  <div id="status"></div>
  <div class="row">
    <div><label>Your Name *</label><input id="name"></div>
    <div><label>How many people? *</label><input id="party" type="number" min="1" step="1" placeholder="1"></div>
  </div>
  <label>Attendance</label>
  <select id="attendance">
    <option value="all">All weekend</option>
    <option value="partial">Some events</option>
    <option value="none">Can't make it</option>
  </select>
  <label>Events you'll attend</label>
  <div id="events-list"></div>
  <label>Is there anything you need to share with us?</label>
  <textarea id="notes" rows="3" placeholder="I love stinky cheese"></textarea>
  <button id="save">Save Changes</button>
</div>
<script>
const qs = new URLSearchParams(location.search);
const token = qs.get('token');
const $ = id => document.getElementById(id);
if (!token) { document.getElementById('status').textContent = 'Missing token.'; throw new Error('no token'); }

fetch('/api/rsvp?token=' + encodeURIComponent(token))
  .then(r => r.json()).then(({ ok, rsvp, error }) => {
    if (!ok) throw new Error(error || 'load failed');
    $('name').value = rsvp.name || '';
    $('party').value = rsvp.partySize || 1;
    $('attendance').value = rsvp.attendance || '';
    $('notes').value = rsvp.notes || '';
  }).catch(e => { document.getElementById('status').textContent = e.message; });

$('save').onclick = async () => {
  const payload = {
    token,
    name: $('name').value.trim(),
    partySize: Number($('party').value)||1,
    attendance: $('attendance').value,
    selectedEvents: Array.from(document.querySelectorAll('#events-list input[type="checkbox"]:checked')).map(cb=>cb.value),
    notes: $('notes').value.trim()
  };
  const r = await fetch('/api/rsvp?token=' + encodeURIComponent(token), {
    method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
  });
  const j = await r.json();
  alert(j.ok ? 'Saved!' : ('Error: ' + (j.error || 'failed')));
};
</script>

<script>
// Build RSVP-like event list UI
(function(){
  const events = [
    { id: 'sat-brunch', day: 'Saturday', time: '10:30 AM', name: 'Brunch', location: 'Route Haggerston' },
    { id: 'sat-lunch', day: 'Saturday', time: '1–5 PM',   name: 'Lunch',  location: 'The Scolts Head' },
    { id: 'sat-dinner', day: 'Saturday', time: '6:00 PM',   name: 'Dinner', location: 'Tonkotsu East' },
    { id: 'sun-church', day: 'Sunday',   time: '11:30 AM',  name: 'Morning Service', location: 'Saint Hackney' },
    { id: 'sun-lunch',  day: 'Sunday',   time: '2–6 PM',    name: 'Lunch',  location: 'Spitalfields Market' },
    { id: 'sun-movie',  day: 'Sunday',   time: '6/7:30 PM', name: 'Movie Night', location: 'TBD' }
  ];
  const list = document.getElementById('events-list');
  if (!list) return;
  ['Saturday','Sunday'].forEach(day => {
    const dayHeader = document.createElement('div');
    dayHeader.textContent = day; dayHeader.style.cssText='font-weight:800;color:#4b5563;margin:8px 0';
    list.appendChild(dayHeader);
    events.filter(e=>e.day===day).forEach(event => {
      const row = document.createElement('label');
      row.style.cssText='display:flex;align-items:flex-start;justify-content:space-between;border:2px solid #e5e7eb;border-radius:10px;padding:12px 14px;margin-bottom:8px;background:#fff';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700;color:#111827">${event.name}</div><div style="font-size:13px;color:#6b7280">${event.time} • ${event.location}</div>`;
      const cb = document.createElement('input'); cb.type='checkbox'; cb.value=event.id; cb.style.marginLeft='12px';
      row.appendChild(left); row.appendChild(cb); list.appendChild(row);
    });
  });
  // prefill from loaded RSVP
  fetch('/api/rsvp?token=' + encodeURIComponent(new URLSearchParams(location.search).get('token')))
    .then(r=>r.json()).then(({ok,rsvp})=>{
      if(!ok||!rsvp) return; const set = new Set(rsvp.selectedEvents||[]);
      document.querySelectorAll('#events-list input[type="checkbox"]').forEach(cb=>{ cb.checked = set.has(cb.value); });
    }).catch(()=>{});
})();
</script>

